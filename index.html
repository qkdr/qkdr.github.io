<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø§ÙƒØ³Ø¨Ù„ÙˆÙŠØª Ø§Ù„Ø¹Ø±Ø¨</title>
  <style>
    :root {
      --bg-light: #ffffff;
      --text-light: #000000;
      --bg-dark: #121212;
      --text-dark: #ffffff;
      --card-bg-light: rgba(0,0,0,0.05);
      --card-bg-dark: rgba(255,255,255,0.1);
      --accent: #ffcc00;
    }
    body {
      margin:0; padding:0;
      font-family:'Tajawal',sans-serif;
      transition:background .3s,color .3s;
    }
    body.light-theme { background: var(--bg-light); color: var(--text-light); }
    body.dark-theme  { background: var(--bg-dark);  color: var(--text-dark);  }

    .topbar {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 20px; background:rgba(0,0,0,0.1);
    }
    body.dark-theme .topbar { background:rgba(255,255,255,0.1); }
    .topbar h1 { margin:0; font-size:1.5em; }
    .buttons { display:flex; align-items:center; }
    .toggle-btn, .auth-btn, .lead-btn {
      margin-left:10px; padding:8px 12px; border:none;
      border-radius:6px; cursor:pointer; transition:background .3s;
    }
    body.light-theme .toggle-btn { background:#333; color:#fff; }
    body.dark-theme  .toggle-btn { background:#eee; color:#000; }
    .auth-btn, .lead-btn { background:#007bff; color:#fff; }
    .auth-btn:hover, .lead-btn:hover { background:#0056b3; }

    #userAvatar {
      width:36px; height:36px; border-radius:50%;
      border:2px solid var(--accent); padding:2px;
      display:none; margin-left:10px;
    }
    #pointsDisplay {
      display:flex; align-items:center; font-weight:bold;
      margin-left:5px; color: var(--accent);
      border:2px solid var(--accent); border-radius:8px;
      padding:2px 6px; display:none;
    }

    .glass {
      background: var(--card-bg-light);
      border-radius:12px; padding:20px; margin:20px auto;
      max-width:900px; transition:background .3s;
    }
    body.dark-theme .glass { background: var(--card-bg-dark); }

    .controls { text-align:center; margin-bottom:15px; }
    select, input[type="text"], .btn {
      padding:8px 12px; border-radius:6px; margin:5px;
      border:1px solid #aaa; font-size:1em;
    }
    body.dark-theme select, body.dark-theme input[type="text"] {
      background:#222; color:#ddd; border-color:#555;
    }
    body.light-theme select, body.light-theme input[type="text"] {
      background:#fff; color:#000;
    }
    .btn.search, #loadMore, .btn.share {
      background:#007bff; color:#fff; border:none; cursor:pointer;
      transition:background .3s;
    }
    .btn.search:hover, #loadMore:hover, .btn.share:hover { background:#0056b3; }

    #searchLabel { display:block; margin-bottom:8px; font-weight:bold; }
    #results { display:flex; flex-wrap:wrap; justify-content:center; }
    .script-card {
      width:240px; margin:10px; border-radius:8px; overflow:hidden;
      background: var(--card-bg-light); transition:transform .2s;
    }
    body.dark-theme .script-card { background: var(--card-bg-dark); }
    .script-card:hover { transform:scale(1.03); }
    .script-card img {
      width:100%; height:140px; object-fit:cover;
    }
    .overlay-left, .overlay-right {
      position:absolute; top:8px; padding:4px 8px;
      background:rgba(0,0,0,0.5); color:#fff; border-radius:4px;
      font-size:.8em;
    }
    .overlay-left { left:8px; }
    .overlay-right { right:8px; }

    .script-info { padding:10px; text-align:center; position:relative; }
    .script-info h3 {
      margin:5px 0; font-size:1em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .script-info .btn-group {
      display:flex; justify-content:space-between;
    }

    #loadMore { display:block; margin:20px auto; }

    .modal {
      position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%) scale(0);
      width:90%; max-width:700px;
      background: var(--bg-light); color: var(--text-light);
      padding:20px; border-radius:8px;
      transition:transform .3s; z-index:1000;
    }
    body.dark-theme .modal {
      background: var(--bg-dark); color: var(--text-dark);
    }
    .modal.show { transform:translate(-50%,-50%) scale(1); }
    .modal .close {
      position:absolute; top:8px; right:12px; cursor:pointer; font-size:1.2em;
    }
    .modal .copy-btn {
      position:absolute; bottom:12px; right:12px;
      padding:6px 12px; background:#28a745; color:#fff;
      border:none; border-radius:4px; cursor:pointer;
    }
    .modal .copy-btn:hover { background:#1e7e34; }
    .modal h2 { margin-top:0; text-align:center; }
    .modal pre {
      max-height:60vh; overflow-y:auto;
      background:rgba(0,0,0,0.05); padding:10px; border-radius:4px;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† */
    #leaderboardPage {
      display:none; padding:20px; max-width:600px; margin:20px auto;
    }
    #leaderboardPage h2 { text-align:center; margin-bottom:10px; }
    #leaderboardList {
      width:100%; border-collapse: collapse; margin-bottom:10px;
    }
    #leaderboardList th, #leaderboardList td {
      border:1px solid #aaa; padding:8px; text-align:center;
    }
    #changeNameBtn {
      margin-bottom:10px; padding:8px 12px; background:var(--accent);
      color:#000; border:none; border-radius:6px; cursor:pointer;
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="light-theme">

  <div class="topbar">
    <h1>Ø§ÙƒØ³Ø¨Ù„ÙˆÙŠØª Ø§Ù„Ø¹Ø±Ø¨</h1>
    <div class="buttons">
      <img id="userAvatar" src="" alt="avatar">
      <div id="pointsDisplay"><span id="pointsCount">0</span></div>
      <button id="authBtn" class="auth-btn">ØªØ³Ø¬ÙŠÙ„/Ø¯Ø®ÙˆÙ„</button>
      <button id="leadBtn" class="lead-btn">Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†</button>
      <button id="themeToggle" class="toggle-btn">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>
    </div>
  </div>

  <div id="leaderboardPage">
    <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h2>
    <button id="changeNameBtn">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button>
    <table id="leaderboardList">
      <thead><tr><th>Ø§Ù„Ù…Ø±ÙƒØ²</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>
      <tbody></tbody>
    </table>
    <button class="btn" onclick="hideLeaderboard()">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <div class="glass" id="mainContent">
    <label id="searchLabel">Ø¨Ø­Ø« Ø¹Ù†: â€”</label>
    <div class="controls">
      <input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙƒØ±Ø¨Øªâ€¦">
      <button id="searchBtn" class="btn search">Ø¨Ø­Ø«</button><br>
      <select id="modeSelect">
        <option value="fetch">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>
        <option value="free">Ù…Ø¬Ø§Ù†ÙŠØ©</option>
        <option value="unverified">ØºÙŠØ± Ù…Ø­Ø­Ù‚Ø©</option>
        <option value="mostviewed">Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©</option>
        <option value="verified">Ù…Ø­Ù‚Ù‚Ø©</option>
      </select>
    </div>
    <div id="results"></div>
    <button id="loadMore" class="btn" style="display:none;">Ø§Ù„Ù…Ø²ÙŠØ¯</button>
  </div>

  <div id="scriptModal" class="modal">
    <span class="close" onclick="closeModal()">âœ–</span>
    <h2 id="scriptTitle"></h2>
    <pre id="scriptContent"></pre>
    <button class="copy-btn" id="copyBtn">Ù†Ø³Ø®</button>
  </div>

  <div id="authModal" style="display:none;">
    <div id="authBox" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:8px;z-index:2000;">
      <span id="authClose" style="position:absolute;top:8px;right:8px;cursor:pointer;">âœ–</span>
      <h3 id="authTitle">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
      <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"><br>
      <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><br>
      <input id="confirmPassword" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="display:none;"><br>
      <button id="authAction" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <p id="toggleAuth" style="text-align:center;cursor:pointer;color:#007bff;">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</p>
    </div>
  </div>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyCSVCz9s7yHQtpOet9txgHl-E4XBgFmMp0",
      authDomain: "qplkow.firebaseapp.com",
      databaseURL: "https://qplkow-default-rtdb.firebaseio.com",
      projectId: "qplkow",
      storageBucket: "qplkow.appspot.com",
      messagingSenderId: "280525591715",
      appId: "1:280525591715:web:d2f750ebf5ceffe6641b16",
      measurementId: "G-ZC8K2PDE60"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    // DOM
    const authBtn      = document.getElementById('authBtn');
    const authModal    = document.getElementById('authModal');
    const authClose    = document.getElementById('authClose');
    const authTitle    = document.getElementById('authTitle');
    const emailInput   = document.getElementById('email');
    const passInput    = document.getElementById('password');
    const confirmInput = document.getElementById('confirmPassword');
    const authAction   = document.getElementById('authAction');
    const toggleAuth   = document.getElementById('toggleAuth');
    const userAvatar   = document.getElementById('userAvatar');
    const pointsDisplay= document.getElementById('pointsDisplay');
    const pointsCount  = document.getElementById('pointsCount');
    const leadBtn      = document.getElementById('leadBtn');
    const leaderboardPage = document.getElementById('leaderboardPage');
    const mainContent    = document.getElementById('mainContent');
    const leaderboardList= document.querySelector('#leaderboardList tbody');
    const changeNameBtn  = document.getElementById('changeNameBtn');
    const themeToggle    = document.getElementById('themeToggle');
    const body           = document.body;

    let isRegister = true;
    function updateAuthUI() {
      if (isRegister) {
        authTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
        confirmInput.style.display = 'block';
        authAction.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
        toggleAuth.textContent = 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„';
      } else {
        authTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„';
        confirmInput.style.display = 'none';
        authAction.textContent = 'Ø¯Ø®ÙˆÙ„';
        toggleAuth.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      }
    }
    authBtn.onclick     = () => authModal.style.display = 'block';
    authClose.onclick   = () => authModal.style.display = 'none';
    toggleAuth.onclick  = () => { isRegister = !isRegister; updateAuthUI(); };
    updateAuthUI();

    authAction.onclick = () => {
      const email = emailInput.value.trim();
      const pass  = passInput.value;
      if (!email||!pass) return alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„');
      if (isRegister) {
        if (pass !== confirmInput.value) return alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø©');
        auth.createUserWithEmailAndPassword(email,pass)
          .then(u=> u.user.sendEmailVerification().then(()=>alert('ØªØ­Ù‚Ù‚ Ø£Ø±Ø³Ù„')));
      } else {
        auth.signInWithEmailAndPassword(email,pass).catch(e=>alert(e.message));
      }
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        // init profile
        const userRef = db.ref('users/'+user.uid);
        userRef.once('value', snap => {
          if (!snap.exists()) {
            userRef.set({ email:user.email, username:user.email.split('@')[0], points:0 });
          }
        });
        userRef.on('value', snap => {
          const data = snap.val();
          // username
          userAvatar.title = data.username || '';
          // gravatar
          const hash = md5(user.email.trim().toLowerCase());
          userAvatar.src = `https://www.gravatar.com/avatar/${hash}?d=identicon&s=64`;
          userAvatar.style.display = 'block';
          // points
          pointsCount.textContent = data.points||0;
          pointsDisplay.style.display = 'flex';
        });
        authBtn.style.display = 'none';
      } else {
        userAvatar.style.display = 'none';
        pointsDisplay.style.display = 'none';
        authBtn.style.display = 'inline-block';
      }
    });

    // change username
    changeNameBtn.onclick = () => {
      const newName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
      if (newName && auth.currentUser) {
        db.ref('users/'+auth.currentUser.uid+'/username').set(newName);
        loadLeaderboard();
      }
    };

    // leaderboard
    leadBtn.onclick = () => {
      if (!auth.currentUser) return alert('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
      mainContent.style.display    = 'none';
      leaderboardPage.style.display= 'block';
      loadLeaderboard();
    };
    function loadLeaderboard() {
      db.ref('users').orderByChild('points').limitToLast(10).once('value', snap => {
        const arr = [];
        snap.forEach(ch => arr.push(ch.val()));
        arr.reverse();
        leaderboardList.innerHTML='';
        arr.forEach((u,i) => {
          leaderboardList.innerHTML += `
            <tr>
              <td>${i+1}</td>
              <td>${u.username}</td>
              <td>${u.points}</td>
            </tr>`;
        });
      });
    }
    function hideLeaderboard() {
      leaderboardPage.style.display='none';
      mainContent.style.display='block';
    }

    // record share
    function recordShare() {
      const uid = auth.currentUser.uid;
      const ref = db.ref('users/'+uid+'/points');
      ref.transaction(p=> (p||0)+1);
      alert('âœ… Ø­ÙØ³Ø¨Øª Ù†Ù‚Ø·Ø© Ù„Ù…Ø´Ø§Ø±ÙƒØªÙƒ!');
    }

    // search & scripts
    let mode='fetch', query='', page=1, total=1;
    const results     = document.getElementById('results');
    const loadMoreBtn = document.getElementById('loadMore');
    const searchInput = document.getElementById('searchInput');
    const searchBtn   = document.getElementById('searchBtn');
    const modeSelect  = document.getElementById('modeSelect');
    const searchLabel = document.getElementById('searchLabel');
    const scriptModal = document.getElementById('scriptModal');
    const tEl         = document.getElementById('scriptTitle');
    const cEl         = document.getElementById('scriptContent');
    const copyBtn     = document.getElementById('copyBtn');

    function proxy(url) {
      return 'https://api.allorigins.win/raw?url='+encodeURIComponent(url);
    }
    function apiURL() {
      const base='https://scriptblox.com/api/script/';
      const p=`&page=${page}`;
      if(mode==='search') return proxy(base+`search?q=${encodeURIComponent(query)}${p}`);
      return proxy(base+
        (mode==='fetch'?`fetch?page=${page}`:
        mode==='free'?`fetch?mode=free${p}`:
        mode==='unverified'?`fetch?verified=0${p}`:
        mode==='mostviewed'?`fetch?sortBy=views&order=desc${p}`:
        `fetch?filters=verified&legacy_filters=true${p}`));
    }

    async function loadScripts() {
      try {
        if(page===1) results.innerHTML=`<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>`;
        const res=await fetch(apiURL());
        const data=await res.json();
        const R=data.result||data; total=R.totalPages||1;
        if(page===1) results.innerHTML='';
        if(!R.scripts||!R.scripts.length) {
          if(page===1) results.innerHTML=`<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</p>`;
        } else {
          R.scripts.forEach(s=>{
            const card=document.createElement('div');
            card.className='script-card';
            const date=new Date(s.createdAt).toLocaleDateString('ar-EG');
            const views=s.views||0;
            card.innerHTML=`
              <div style="position:relative;">
                <img src="${s.game?.imageUrl||s.image||'https://via.placeholder.com/240x140'}" alt="">
                <div class="overlay-left">ğŸ‘ï¸ ${views}</div>
                <div class="overlay-right">ğŸ“… ${date}</div>
              </div>
              <div class="script-info">
                <h3>${s.title}</h3>
                <div class="btn-group">
                  <button class="btn share" onclick="shareScript('${s.title}')">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                  <button class="btn" onclick="showScript('${s.slug}','${s.title}')">Ø¹Ø±Ø¶</button>
                </div>
              </div>`;
            results.appendChild(card);
          });
        }
        loadMoreBtn.style.display= page<total?'block':'none';
      } catch {
        results.innerHTML=`<p>âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹</p>`;
      }
    }

    async function shareScript(title) {
      if(!auth.currentUser) return alert('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
      try {
        await navigator.share({ title, url: window.location.href });
        recordShare();
      } catch {
        alert('ÙØ´Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
      }
    }

    async function showScript(slug,title) {
      try {
        const res=await fetch(proxy(`https://scriptblox.com/api/script/${slug}`));
        const d=await res.json(), sc=d.script;
        if(sc&&sc.script) {
          tEl.textContent=title; cEl.textContent=sc.script;
          scriptModal.classList.add('show');
        } else alert('âš ï¸ ØºÙŠØ± Ù…ØªØ§Ø­');
      } catch {
        alert('âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
      }
    }
    function closeModal(){ scriptModal.classList.remove('show'); }

    function doSearch() {
      const q=searchInput.value.trim();
      if(!q) return alert('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø«');
      query=q; mode='search'; page=1; results.innerHTML='';
      searchLabel.textContent=`Ø¨Ø­Ø« Ø¹Ù†: ${q}`; loadScripts();
    }
    searchBtn.addEventListener('click', doSearch);
    searchInput.addEventListener('keypress', e=>{ if(e.key==='Enter') doSearch(); });
    modeSelect.addEventListener('change', ()=>{
      mode=modeSelect.value; query=''; page=1; results.innerHTML='';
      searchLabel.textContent='Ø¨Ø­Ø« Ø¹Ù†: â€”'; loadScripts();
    });
    loadMoreBtn.addEventListener('click', ()=>{ if(page<total){ page++; loadScripts(); }});
    themeToggle.addEventListener('click', ()=>{
      if(body.classList.contains('light-theme')) {
        body.classList.replace('light-theme','dark-theme');
        themeToggle.textContent='Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­';
      } else {
        body.classList.replace('dark-theme','light-theme');
        themeToggle.textContent='Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ';
      }
    });
    window.addEventListener('load', loadScripts);

    // MD5 for Gravatar
    function md5(string) {
      function RotateLeft(lValue, iShiftBits) { return (lValue<<iShiftBits)|(lValue>>>(32-iShiftBits)); }
      function AddUnsigned(lX,lY) {
        const lX4=lX&0x40000000,lY4=lY&0x40000000,lX8=lX&0x80000000,lY8=lY&0x80000000;
        let lResult=(lX&0x3FFFFFFF)+(lY&0x3FFFFFFF);
        if(lX4&&lY4) return lResult^0x80000000^lX8^lY8;
        if(lX4||lY4) {
          if(lResult&0x40000000) return lResult^0xC0000000^lX8^lY8;
          else return lResult^0x40000000^lX8^lY8;
        }
        return lResult^lX8^lY8;
      }
      function F(x,y,z){return(x&y)|((~x)&z);}
      function G(x,y,z){return(x&z)|(y&(~z));}
      function H(x,y,z){return x^y^z;}
      function I(x,y,z){return y^(x|(~z));}
      function FF(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);}
      function GG(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);}
      function HH(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);}
      function II(a,b,c,d,x,s,ac){a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac));return AddUnsigned(RotateLeft(a,s),b);}
      function ConvertToWordArray(str){
        const lWordCount=[]; let lMessageLength=str.length, lNumberOfWords_temp1=lMessageLength+8;
        const lNumberOfWords_temp2=(lNumberOfWords_temp1-(lNumberOfWords_temp1%64))/64;
        const lNumberOfWords=(lNumberOfWords_temp2+1)*16;
        for(let i=0;i<lNumberOfWords;i++)lWordCount[i]=0;
        let lBytePosition=0,lByteCount=0;
        while(lByteCount<lMessageLength){
          const lWordCountIndex=(lByteCount-(lByteCount%4))/4;
          lBytePosition=(lByteCount%4)*8;
          lWordCount[lWordCountIndex]|=(str.charCodeAt(lByteCount)<<lBytePosition);
          lByteCount++;
        }
        const lWordCountIndex=(lByteCount-(lByteCount%4))/4;
        lBytePosition=(lByteCount%4)*8;
        lWordCount[lWordCountIndex]|=0x80<<lBytePosition;
        lWordCount[lNumberOfWords-2]=lMessageLength<<3;
        lWordCount[lNumberOfWords-1]=lMessageLength>>>29;
        return lWordCount;
      }
      function WordToHex(lValue){
        let WordToHexValue="",WordToHexValue_temp="",lByte,lCount;
        for(lCount=0;lCount<=3;lCount++){
          lByte=(lValue>>>(lCount*8))&255;
          WordToHexValue_temp="0"+lByte.toString(16);
          WordToHexValue+=WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);
        }
        return WordToHexValue;
      }
      let x=ConvertToWordArray(string),a=0x67452301,b=0xEFCDAB89,c=0x98BADCFE,d=0x10325476;
      for(let k=0;k<x.length;k+=16){
        const AA=a,BB=b,CC=c,DD=d;
        a=FF(a,b,c,d,x[k+0],7,0xD76AA478);
        a=FF(a,b,c,d,x[k+1],12,0xE8C7B756);
        a=FF(a,b,c,d,x[k+2],17,0x242070DB);
        a=FF(a,b,c,d,x[k+3],22,0xC1BDCEEE);
        a=FF(a,b,c,d,x[k+4],7,0xF57C0FAF);
        a=FF(a,b,c,d,x[k+5],12,0x4787C62A);
        a=FF(a,b,c,d,x[k+6],17,0xA8304613);
        a=FF(a,b,c,d,x[k+7],22,0xFD469501);
        a=FF(a,b,c,d,x[k+8],7,0x698098D8);
        a=FF(a,b,c,d,x[k+9],12,0x8B44F7AF);
        a=FF(a,b,c,d,x[k+10],17,0xFFFF5BB1);
        a=FF(a,b,c,d,x[k+11],22,0x895CD7BE);
        a=FF(a,b,c,d,x[k+12],7,0x6B901122);
        a=FF(a,b,c,d,x[k+13],12,0xFD987193);
        a=FF(a,b,c,d,x[k+14],17,0xA679438E);
        a=FF(a,b,c,d,x[k+15],22,0x49B40821);
        b=GG(b,c,d,a,x[k+1],5,0xF61E2562);
        b=GG(b,c,d,a,x[k+6],9 ,0xC040B340);
        b=GG(b,c,d,a,x[k+11],14,0x265E5A51);
        b=GG(b,c,d,a,x[k+0],20,0xE9B6C7AA);
        b=GG(b,c,d,a,x[k+5],5 ,0xD62F105D);
        b=GG(b,c,d,a,x[k+10],9,0x2441453);
        b=GG(b,c,d,a,x[k+15],14,0xD8A1E681);
        b=GG(b,c,d,a,x[k+4],20,0xE7D3FBC8);
        b=GG(b,c,d,a,x[k+9],5 ,0x21E1CDE6);
        b=GG(b,c,d,a,x[k+14],9,0xC33707D6);
        b=GG(b,c,d,a,x[k+3],14,0xF4D50D87);
        b=GG(b,c,d,a,x[k+8],20,0x455A14ED);
        b=GG(b,c,d,a,x[k+13],5,0xA9E3E905);
        b=GG(b,c,d,a,x[k+2],9,0xFCEFA3F8);
        b=GG(b,c,d,a,x[k+7],14,0x676F02D9);
        b=GG(b,c,d,a,x[k+12],20,0x8D2A4C8A);
        c=HH(c,d,a,b,x[k+5],4,0xFFFA3942);
        c=HH(c,d,a,b,x[k+8],11,0x8771F681);
        c=HH(c,d,a,b,x[k+11],16,0x6D9D6122);
        c=HH(c,d,a,b,x[k+14],23,0xFDE5380C);
        c=HH(c,d,a,b,x[k+1],4,0xA4BEEA44);
        c=HH(c,d,a,b,x[k+4],11,0x4BDECFA9);
        c=HH(c,d,a,b,x[k+7],16,0xF6BB4B60);
        c=HH(c,d,a,b,x[k+10],23,0xBEBFBC70);
        c=HH(c,d,a,b,x[k+13],4,0x289B7EC6);
        c=HH(c,d,a,b,x[k+0],11,0xEAA127FA);
        c=HH(c,d,a,b,x[k+3],16,0xD4EF3085);
        c=HH(c,d,a,b,x[k+6],23,0x4881D05);
        c=HH(c,d,a,b,x[k+9],4,0xD9D4D039);
        c=HH(c,d,a,b,x[k+12],11,0xE6DB99E5);
        c=HH(c,d,a,b,x[k+15],16,0x1FA27CF8);
        c=HH(c,d,a,b,x[k+2],23,0xC4AC5665);
        d=II(d,a,b,c,x[k+0],6,0xF4292244);
        d=II(d,a,b,c,x[k+7],10,0x432AFF97);
        d=II(d,a,b,c,x[k+14],15,0xAB9423A7);
        d=II(d,a,b,c,x[k+5],21,0xFC93A039);
        d=II(d,a,b,c,x[k+12],6,0x655B59C3);
        d=II(d,a,b,c,x[k+3],10,0x8F0CCC92);
        d=II(d,a,b,c,x[k+10],15,0xFFEFF47D);
        d=II(d,a,b,c,x[k+1],21,0x85845DD1);
        d=II(d,a,b,c,x[k+8],6,0x6FA87E4F);
        d=II(d,a,b,c,x[k+15],10,0xFE2CE6E0);
        d=II(d,a,b,c,x[k+6],15,0xA3014314);
        d=II(d,a,b,c,x[k+13],21,0x4E0811A1);
        d=II(d,a,b,c,x[k+4],6,0xF7537E82);
        d=II(d,a,b,c,x[k+11],10,0xBD3AF235);
        d=II( d,a,b,c,x[k+2],15,0x2AD7D2BB);
        d=II(d,a,b,c,x[k+9],21,0xEB86D391);
        a=AddUnsigned(a,AA); b=AddUnsigned(b,BB);
        c=AddUnsigned(c,CC); d=AddUnsigned(d,DD);
      }
      return (WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d)).toLowerCase();
    }
  </script>
</body>
</html>
