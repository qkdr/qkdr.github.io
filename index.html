<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لعبة الذاكرة – مركز النقاط والمتجر</title>
  
  <!-- أيقونات Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" 
        integrity="sha512-..." crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- سكربت تلغرام -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* إعدادات عامة */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #312c51;
      color: #f0c38e;
      overflow-x: hidden;
    }
    /* رأس الصفحة: عرض النقاط وأزرار المتجر واللوحة */
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5em 1em;
      background: #48426d;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    #scoreDisplay {
      font-size: 1.2em;
      display: flex;
      align-items: center;
    }
    #scoreDisplay i {
      margin-right: 0.3em;
    }
    #actions {
      display: flex;
      gap: 1em;
      font-size: 1.4em;
    }
    #actions i {
      cursor: pointer;
      transition: transform 0.3s;
    }
    #actions i:hover {
      transform: scale(1.2);
    }
    /* منطقة اللعبة: شبكة البطاقات */
    .game {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      width: 90vh;
      height: 90vh;
      margin: 1em auto;
      perspective: 1000px;
    }
    /* تصميم البطاقة مع دوران ثلاثي الأبعاد */
    .card {
      position: relative;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }
    .card.flip .card-inner {
      transform: rotateY(180deg);
    }
    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2em;
      font-weight: bold;
      transition: background 0.3s, box-shadow 0.3s;
    }
    /* الوجه الخلفي (يظهر دائماً قبل قلب البطاقة) */
    .card-face.back {
      background: #48426d;
      color: #f0c38e;
    }
    /* الوجه الأمامي (يظهر عند قلب البطاقة) */
    .card-face.front {
      background: #f1aa9b;
      color: #48426d;
      transform: rotateY(180deg);
    }
    .card:hover {
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    /* زر إعادة اللعبة والمؤقت */
    #newgame, #timer {
      text-align: center;
      margin: 0.5em auto;
      padding: 0.8em 1em;
      border-radius: 5px;
      font-size: 1.2em;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      background: #f1aa9b;
      color: #48426d;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      width: fit-content;
    }
    #newgame:hover, #timer:hover {
      transform: scale(1.05);
    }
    #newgame {
      display: none;
    }
    /* النوافذ (مودالات) – المتجر، ترتيب النقاط وإدخال اسم المستخدم */
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #48426d;
      color: #f0c38e;
      padding: 1.5em;
      border-radius: 10px;
      z-index: 1000;
      width: 80%;
      max-width: 400px;
      display: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    }
    .modal h2 {
      margin-top: 0;
      text-align: center;
    }
    .modal .modal-close {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 1.5em;
      cursor: pointer;
    }
    #storeModal .item, #rankingModal .rankItem {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5em 0;
      border-bottom: 1px solid #777;
    }
    #storeModal .item:last-child, #rankingModal .rankItem:last-child {
      border-bottom: none;
    }
    #storeModal .item button {
      background: #f1aa9b;
      border: none;
      padding: 0.3em 0.6em;
      border-radius: 5px;
      cursor: pointer;
      color: #48426d;
    }
    /* مدخل اسم المستخدم */
    #usernameModal input {
      width: 80%;
      padding: 0.5em;
      border-radius: 5px;
      border: none;
      margin-top: 1em;
      font-size: 1em;
    }
    #usernameModal button {
      margin-top: 1em;
      background: #f1aa9b;
      border: none;
      padding: 0.5em 1em;
      border-radius: 5px;
      cursor: pointer;
      color: #48426d;
      font-size: 1em;
    }
    /* استجابة للشاشات العمودية */
    @media screen and (orientation: portrait) {
      .game {
        width: 90vw;
        height: 90vw;
      }
      #newgame, #timer {
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <!-- رأس الصفحة -->
  <div id="header">
    <div id="scoreDisplay">
      <i class="fas fa-star"></i>
      <span id="score">0</span> نقطة
    </div>
    <div id="actions">
      <i class="fas fa-store" id="storeButton" title="المتجر"></i>
      <i class="fas fa-trophy" id="rankingButton" title="مركز النقاط"></i>
    </div>
  </div>
  
  <!-- منطقة اللعبة -->
  <div class="game"></div>
  
  <!-- المؤقت وزر إعادة اللعبة -->
  <div id="timer">30</div>
  <div id="newgame">اللعب مرة أخرى</div>

  <!-- نافذة المتجر -->
  <div class="modal" id="storeModal">
    <i class="fas fa-times modal-close" id="closeStore"></i>
    <h2>المتجر</h2>
    <!-- عنصر المتجر: تأثير تغيير لون البطاقات عند النقر -->
    <div class="item">
      <span><i class="fas fa-tint"></i> تأثير اللون الخاص</span>
      <span>السعر: <span id="itemPrice">5</span> نقطة</span>
      <button id="buyItem">شراء</button>
    </div>
  </div>

  <!-- نافذة ترتيب النقاط / مركز النقاط -->
  <div class="modal" id="rankingModal">
    <i class="fas fa-times modal-close" id="closeRanking"></i>
    <h2>مركز النقاط</h2>
    <div id="rankingList">
      <!-- هنا يتم تعبئة ترتيب النقاط -->
    </div>
  </div>

  <!-- نافذة إدخال اسم المستخدم -->
  <div class="modal" id="usernameModal">
    <h2>أدخل اسمك</h2>
    <p>يمكن تغييره مرة واحدة كل أسبوع</p>
    <input type="text" id="usernameInput" placeholder="اسم المستخدم">
    <button id="saveUsername">حفظ</button>
  </div>

  <script>
    // تهيئة Telegram WebApp والتأكد من تطبيق الثيم
    let tg = window.Telegram.WebApp;
    tg.expand();
    document.body.style.background = tg.themeParams.bg_color ? tg.themeParams.bg_color : "#312c51";
    document.getElementById('newgame').style.background = tg.themeParams.button_color ? tg.themeParams.button_color : "#48426d";
    document.getElementById('newgame').style.color = tg.themeParams.button_text_color ? tg.themeParams.button_text_color : "#f0c38e";
    
    // المتغيرات العامة
    const cardCount = 16;
    let firstCard = null;
    let timerInterval;
    let purchasedEffect = false; // هل تم شراء التأثير؟
    const itemPrice = 5; // السعر الخاص بالتأثير
    // تخزين النقاط بشكل دائم (مركز النقاط)؛ إذا لم يوجد يتم تهيئته ب 0
    let persistentScore = parseInt(localStorage.getItem("score_center")) || 0;
    
    // عناصر الواجهة
    const scoreDisplay = document.getElementById('score');
    const gameContainer = document.querySelector('.game');
    const newGameBtn = document.getElementById('newgame');
    const timerElement = document.getElementById("timer");
    
    const storeModal = document.getElementById('storeModal');
    const rankingModal = document.getElementById('rankingModal');
    const usernameModal = document.getElementById('usernameModal');
    
    const storeButton = document.getElementById('storeButton');
    const rankingButton = document.getElementById('rankingButton');
    const closeStore = document.getElementById('closeStore');
    const closeRanking = document.getElementById('closeRanking');
    const buyItem = document.getElementById('buyItem');
    
    const usernameInput = document.getElementById('usernameInput');
    const saveUsernameBtn = document.getElementById('saveUsername');
    
    // مفاتيح التخزين
    const USERNAME_KEY = "game_username";
    const USERNAME_TIMESTAMP_KEY = "game_username_timestamp";
    const RANKING_KEY = "game_ranking"; // مصفوفة من الكائنات: [{ name: ..., points: ...}, ...]
    
    // التحقق من اسم المستخدم (تغيير مرة واحدة في الأسبوع)
    function checkUsername() {
      let storedName = localStorage.getItem(USERNAME_KEY);
      let storedTimestamp = localStorage.getItem(USERNAME_TIMESTAMP_KEY);
      const weekInMs = 7 * 24 * 60 * 60 * 1000;
      if (storedName && storedTimestamp && (Date.now() - storedTimestamp < weekInMs)) {
        tg.username = storedName;
      } else {
        usernameModal.style.display = "block";
      }
    }
    saveUsernameBtn.addEventListener('click', () => {
      const nameVal = usernameInput.value.trim();
      if (nameVal !== "") {
        localStorage.setItem(USERNAME_KEY, nameVal);
        localStorage.setItem(USERNAME_TIMESTAMP_KEY, Date.now());
        tg.username = nameVal;
        usernameModal.style.display = "none";
      }
    });
    checkUsername();
    
    // تحديث النقاط وحفظها في الـ localStorage وتحديث مركز النقاط
    function updateScore(newScore) {
      persistentScore = newScore;
      scoreDisplay.innerText = persistentScore;
      localStorage.setItem("score_center", persistentScore);
      updateRankingData();
    }
    
    // تحديث بيانات مركز النقاط لكل لاعب
    function updateRankingData() {
      const username = tg.username || "اللاعب";
      let ranking = JSON.parse(localStorage.getItem(RANKING_KEY)) || [];
      const index = ranking.findIndex(item => item.name === username);
      if (index > -1) {
        ranking[index].points = persistentScore;
      } else {
        ranking.push({ name: username, points: persistentScore });
      }
      // ترتيب تنازلي حسب النقاط
      ranking.sort((a, b) => b.points - a.points);
      localStorage.setItem(RANKING_KEY, JSON.stringify(ranking));
    }
    
    // إنشاء مصفوفة عشوائية للأرقام، كل رقم يظهر مرتين
    function generateNumbers() {
      let numbers = [];
      while (numbers.length < cardCount) {
        const rand = Math.floor(Math.random() * (cardCount / 2)) + 1;
        if (numbers.filter(num => num === rand).length < 2) {
          numbers.push(rand);
        }
      }
      // خلط المصفوفة عشوائيًا
      return numbers.sort(() => Math.random() - 0.5);
    }
    
    // إنشاء البطاقات باستخدام تقنية flip card (بطاقة داخلها عنصر داخلي يدور)
    function createGame() {
      firstCard = null;
      gameContainer.innerHTML = "";
      gameContainer.style.pointerEvents = "auto";
      newGameBtn.style.display = "none";
      timerElement.style.display = "block";
      // عدم إعادة تعيين النقاط؛ نستمر بنفس النقاط المخزنة
      // في حالة عدم وجود نقاط يتم اعتبارها 0
      persistentScore = parseInt(localStorage.getItem("score_center")) || 0;
      scoreDisplay.innerText = persistentScore;
    
      const numbers = generateNumbers();
    
      // إنشاء كل بطاقة
      for (let i = 0; i < cardCount; i++) {
        const card = document.createElement('div');
        card.classList.add('card');
    
        const cardInner = document.createElement('div');
        cardInner.classList.add('card-inner');
    
        // الوجه الأمامي: يظهر الرقم عند التقليب (مع تدوير داخلي بحيث لا يظهر معكوسًا)
        const frontFace = document.createElement('div');
        frontFace.classList.add('card-face', 'front');
        frontFace.innerText = numbers[i];
    
        // الوجه الخلفي: تصميم ثابت يمكن وضع رمز أو صورة
        const backFace = document.createElement('div');
        backFace.classList.add('card-face', 'back');
        backFace.innerHTML = "<i class='fas fa-question'></i>";
    
        cardInner.append(frontFace);
        cardInner.append(backFace);
        card.append(cardInner);
    
        // عند النقر على البطاقة
        card.addEventListener('click', function() {
          if (card.classList.contains('flip')) return;
          flipCard(card);
        });
    
        gameContainer.append(card);
      }
    
      // إعادة ضبط المؤقت (30 ثانية)
      timerElement.innerText = 30;
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        let t = parseInt(timerElement.innerText);
        if (t > 0) {
          timerElement.innerText = t - 1;
        } else {
          endGame(false);
        }
      }, 1000);
    }
    
    // دالة قلب البطاقة ومقارنة القيم
    function flipCard(card) {
      card.classList.add('flip');
      if (purchasedEffect) {
        // إذا تم شراء التأثير، يمكن تغيير لون البطاقة عند النقر
        card.querySelector('.card-inner').style.background = "#28a745";
      }
      gameContainer.style.pointerEvents = "none";
      if (!firstCard) {
        firstCard = card;
        gameContainer.style.pointerEvents = "auto";
      } else {
        // مقارنة الرقم بين البطاقة الأولى والثانية
        const firstValue = firstCard.querySelector('.card-face.front').innerText;
        const secondValue = card.querySelector('.card-face.front').innerText;
    
        if (firstValue === secondValue) {
          // تطابق، زيادة النقاط بمقدار نقطة واحدة
          updateScore(persistentScore + 1);
          firstCard = null;
          gameContainer.style.pointerEvents = "auto";
          // التحقق من انتهاء اللعبة (جميع البطاقات مقلوبة)
          if (document.querySelectorAll('.card.flip').length === cardCount) {
            endGame(true);
          }
        } else {
          setTimeout(() => {
            firstCard.classList.remove('flip');
            card.classList.remove('flip');
            gameContainer.style.pointerEvents = "auto";
            firstCard = null;
          }, 600);
        }
      }
    }
    
    // انتهاء اللعبة: فوز أو خسارة
    function endGame(won) {
      clearInterval(timerInterval);
      timerElement.style.display = "none";
      gameContainer.style.pointerEvents = "none";
      if (won) {
        newGameBtn.innerText = "فزت! العب مرة أخرى";
      } else {
        newGameBtn.innerText = "انتهى الوقت! العب مرة أخرى";
      }
      newGameBtn.style.display = "block";
    }
    
    // إعادة بدء اللعبة عند النقر على زر "اللعب مرة أخرى"
    newGameBtn.addEventListener('click', createGame);
    
    // فتح وإغلاق نافذة المتجر
    storeButton.addEventListener('click', () => {
      storeModal.style.display = "block";
    });
    closeStore.addEventListener('click', () => {
      storeModal.style.display = "none";
    });
    
    // شراء التأثير إذا توفر عدد نقاط كافٍ
    buyItem.addEventListener('click', () => {
      if (persistentScore >= itemPrice && !purchasedEffect) {
        updateScore(persistentScore - itemPrice);
        purchasedEffect = true;
        buyItem.disabled = true;
        buyItem.innerText = "تم الشراء";
      }
    });
    
    // فتح وإغلاق نافذة مركز النقاط
    rankingButton.addEventListener('click', () => {
      showRanking();
      rankingModal.style.display = "block";
    });
    closeRanking.addEventListener('click', () => {
      rankingModal.style.display = "none";
    });
    
    // عرض مركز النقاط
    function showRanking() {
      let ranking = JSON.parse(localStorage.getItem(RANKING_KEY)) || [];
      const rankingList = document.getElementById('rankingList');
      rankingList.innerHTML = "";
      if(ranking.length === 0) {
        rankingList.innerHTML = "<p>لا توجد بيانات بعد</p>";
        return;
      }
      ranking.forEach((item, index) => {
        const div = document.createElement('div');
        div.classList.add('rankItem');
        div.style.padding = "0.3em 0";
        div.style.display = "flex";
        div.style.justifyContent = "space-between";
        div.innerHTML = `<span>${index + 1}. ${item.name}</span><span>${item.points} نقطة</span>`;
        rankingList.append(div);
      });
    }
    
    // بدء اللعبة عند تحميل الصفحة
    createGame();
  </script>
</body>
</html>
