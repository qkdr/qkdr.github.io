<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>محرر بسيط ومباشر لـ Lord.lua</title>
  <style>
    :root{--bg:#f7f7fb;--card:#fff;--muted:#666}
    body{font-family:system-ui,Arial;direction:rtl;background:var(--bg);margin:0;padding:18px}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(10,10,10,0.06);margin-top:12px}
    label{display:block;margin:8px 0 4px;font-weight:600}
    input[type=text], input[type=password], textarea, select {
      width:100%;padding:8px;border:1px solid #ddd;border-radius:8px;font-family:inherit;
    }
    textarea{height:360px; font-family: monospace; font-size:13px; white-space:pre; overflow:auto; }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0b76ef;color:#fff;cursor:pointer}
    button.secondary{background:#6b7280}
    .note{color:var(--muted);font-size:13px;margin-top:8px}
    .danger{color:#b91c1c}
    @media (max-width:720px){ .row{grid-template-columns:1fr} header{flex-direction:column;align-items:start} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>محرر بسيط لـ <code>Lord.lua</code> — ملف واحد</h1>
      <div style="text-align:left;font-size:13px;color:#444">جَهِّز الملف — أضف سطر — نفّذ</div>
    </header>

    <div class="card">
      <div class="row">
        <div>
          <label>Owner (مالك المستودع)</label>
          <input id="owner" type="text" value="qkdr" />
        </div>
        <div>
          <label>Repo (المستودع)</label>
          <input id="repo" type="text" value="Lord" />
        </div>
      </div>

      <label>Path (مسار الملف داخل المستودع)</label>
      <input id="path" type="text" value="Lord.lua" />

      <div class="row" style="margin-top:8px">
        <div>
          <label>Token لـ GitHub (اختياري للرفع — لن أحتفظ به)</label>
          <input id="token" type="password" placeholder="ألصق توكن هنا فقط عند الرفع ثم امسحه" />
        </div>
        <div>
          <label>Branch (الفرع)</label>
          <input id="branch" type="text" value="main" />
        </div>
      </div>

      <div style="margin-top:10px" class="controls">
        <button id="loadBtn">جلب الملف من GitHub</button>
        <button id="downloadBtn" class="secondary">تنزيل الملف المحدث</button>
        <button id="uploadBtn">رفع إلى GitHub</button>
        <button id="clearTokenBtn" class="secondary">مسح التوكن الآن</button>
      </div>

      <p class="note">
        ملاحظة أمنية: لا تشارك التوكن. أعطِ التوكن أقل صلاحيات لازمة (لملفات عامة: scope = <code>public_repo</code>). 
        إن شككت أنه انكشف، اذهب لحساب GitHub واغِلقه (revoke).
      </p>
    </div>

    <div class="card">
      <label>اكتب السطر الذي تريد إضافته (مثال: <code>[] = ""</code>)</label>
      <input id="newLine" type="text" placeholder='اكتب هنا السطر الجديد مثل: [] = ""' />

      <div class="controls">
        <button id="appendBtn">إضافة للسطر</button>
        <button id="prependBtn" class="secondary">إضافة في الأعلى</button>
        <button id="clearBtn" class="secondary">مسح الحقل</button>
      </div>

      <label style="margin-top:12px">محرر الملف (محتوى Lord.lua)</label>
      <textarea id="editor" placeholder="محتوى Lord.lua سيظهر هنا..."></textarea>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="formatBtn" class="secondary">ترتيب محاك</button>
        <button id="selectAllBtn" class="secondary">تحديد الكل</button>
      </div>

      <p class="note">الوظيفة "رفع إلى GitHub" تستخدم GitHub REST API لعمل commit. إذا كان الملف غير موجود، سينشأ جديداً.</p>
    </div>

    <div class="card">
      <strong>سجل الأحداث:</strong>
      <pre id="log" style="white-space:pre-wrap;height:100px;overflow:auto;background:#f3f6fb;padding:8px;border-radius:8px"></pre>
    </div>
  </div>

<script>
/* ======== Utilities ======== */
const $ = id => document.getElementById(id);
const logEl = $('log');
function log(...args){ const t = '['+new Date().toLocaleTimeString()+'] ' + args.join(' '); logEl.textContent = t + '\n' + logEl.textContent; }

function utf8_to_b64(str){ return btoa(unescape(encodeURIComponent(str||""))); }
function b64_to_utf8(b64){ try{ return decodeURIComponent(escape(atob(b64))); }catch(e){ return atob(b64); } }

/* ======== DOM ======== */
const ownerEl = $('owner'), repoEl = $('repo'), pathEl = $('path'), branchEl = $('branch'), tokenEl = $('token');
const loadBtn = $('loadBtn'), downloadBtn = $('downloadBtn'), uploadBtn = $('uploadBtn'), clearTokenBtn = $('clearTokenBtn');
const editor = $('editor'), newLine = $('newLine');
const appendBtn = $('appendBtn'), prependBtn = $('prependBtn'), clearBtn = $('clearBtn');
const formatBtn = $('formatBtn'), selectAllBtn = $('selectAllBtn');

/* ======== Core ======== */
function apiBase(owner, repo, path){
  return `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
}

async function loadFile(){
  const owner = ownerEl.value.trim(), repo = repoEl.value.trim(), path = pathEl.value.trim(), branch = branchEl.value.trim();
  if(!owner||!repo||!path){ alert('املأ owner, repo, path'); return; }
  const url = apiBase(owner,repo,path) + (branch ? `?ref=${encodeURIComponent(branch)}` : '');
  log('جلب من', url);
  try{
    const res = await fetch(url, { headers: { Accept: 'application/vnd.github.v3+json' }});
    if(res.status===404){ editor.value = "-- الملف غير موجود (404). يمكنك إنشاءه وإضافة محتوى.\n"; log('الملف غير موجود (404)'); return; }
    if(!res.ok) throw new Error('HTTP ' + res.status + ' ' + await res.text());
    const json = await res.json();
    const content = json.content ? b64_to_utf8(json.content.replace(/\n/g,'')) : '';
    editor.value = content;
    editor.dataset.sha = json.sha || '';
    log('تم الجلب بنجاح. sha:', editor.dataset.sha);
  }catch(err){
    editor.value = `-- خطأ عند جلب الملف:\n-- ${err.message}\n`;
    log('خطأ جلب الملف:', err.message);
  }
}

function appendLine(){
  const line = newLine.value;
  if(!line){ alert('أدخل السطر أولاً'); return; }
  // نضيف السطر في الأسفل
  editor.value = editor.value.replace(/\s+$/,'') + "\n" + line + "\n";
  newLine.value = '';
  log('أضيف سطر في الأسفل');
}

function prependLine(){
  const line = newLine.value;
  if(!line){ alert('أدخل السطر أولاً'); return; }
  editor.value = line + "\n" + editor.value;
  newLine.value = '';
  log('أضيف سطر في الأعلى');
}

function downloadFile(){
  const blob = new Blob([editor.value], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = pathEl.value || 'file.lua';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  log('تم تنزيل الملف محلياً');
}

async function uploadToGitHub(){
  const owner = ownerEl.value.trim(), repo = repoEl.value.trim(), path = pathEl.value.trim(), branch = branchEl.value.trim();
  const token = tokenEl.value.trim();
  if(!owner||!repo||!path){ alert('املأ owner, repo, path'); return; }
  if(!token){ if(!confirm('لم تدخل توكن. تريد المتابعة بدون توكن (لن ينجح الرفع)؟')) return; }
  const url = apiBase(owner,repo,path);
  const headers = { Accept:'application/vnd.github.v3+json', Authorization: token ? 'token '+token : undefined };
  log('جلب بيانات الملف قبل الرفع...');
  let sha = null;
  // احصل على sha إن وُجد
  try{
    const getRes = await fetch(url + (branch ? `?ref=${encodeURIComponent(branch)}` : ''), { headers });
    if(getRes.status===200){
      const j = await getRes.json();
      sha = j.sha;
      log('sha موجود:', sha);
    } else if(getRes.status===404){
      log('الملف غير موجود على المستودع — سينشأ ملف جديد.');
    } else {
      const txt = await getRes.text();
      log('رد غير متوقع من GET:', getRes.status, txt);
      // لكن نستمر ونحاول إنشاء/تحديث
    }
  }catch(e){
    log('خطأ أثناء جلب الملف ( لاستشفاء sha ):', e.message);
  }

  // تحضير المحتوى
  const content = editor.value;
  const content_b64 = utf8_to_b64(content);
  const body = { message: `Update ${path} via web editor`, content: content_b64 };
  if(branch) body.branch = branch;
  if(sha) body.sha = sha;

  log('إرسال PUT إلى GitHub API...');
  try{
    const putRes = await fetch(url, { method:'PUT', headers: { 'Content-Type':'application/json', Accept:'application/vnd.github.v3+json', Authorization: token ? 'token '+token : undefined }, body: JSON.stringify(body) });
    const txt = await putRes.text();
    if(putRes.status===201 || putRes.status===200){
      const j = JSON.parse(txt);
      editor.dataset.sha = j.content && j.content.sha ? j.content.sha : '';
      log('نجح الرفع! commit:', j.commit && j.commit.sha ? j.commit.sha : '(unknown)');
      alert('نجح الرفع إلى GitHub!');
    } else {
      log('فشل الرفع: HTTP ' + putRes.status + ' — ' + txt);
      alert('فشل الرفع. راجع السجل أسفل الصفحة.');
    }
  }catch(e){
    log('خطأ أثناء رفع الملف:', e.message);
    alert('حدث خطأ أثناء الرفع. افتح السجل لمزيد.');
  }
}

/* ======== Small helpers ======== */
selectAllBtn.addEventListener('click', ()=>{ editor.select(); });
clearBtn.addEventListener('click', ()=>{ newLine.value=''; });
clearTokenBtn.addEventListener('click', ()=>{ tokenEl.value=''; log('تم مسح التوكن من الحقل'); });

loadBtn.addEventListener('click', loadFile);
downloadBtn.addEventListener('click', downloadFile);
appendBtn.addEventListener('click', appendLine);
prependBtn.addEventListener('click', prependLine);
uploadBtn.addEventListener('click', async () => {
  if(!confirm('سترفع التغييرات مباشرة إلى المستودع (ستحتاج توكن صالح). تأكد أنك تريد المتابعة.')) return;
  await uploadToGitHub();
});

formatBtn.addEventListener('click', ()=>{
  // بسيطة: نحافظ على نفس المحتوى، أو نقدر نعمل replace لآخر سطور
  editor.value = editor.value.replace(/\r\n/g, '\n').replace(/\t/g,'    ');
  log('تم تطبيق تحسين بسيط للترتيب (تحويل تبويبات إلى مسافات)');
});

/* تحميل تلقائي لأول مرة */
loadFile();

</script>
</body>
</html>
