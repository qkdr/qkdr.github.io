<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø§ÙƒØ³Ø¨Ù„ÙˆÙŠØª Ø§Ù„Ø¹Ø±Ø¨</title>
  <style>
    :root {
      --bg-light: #ffffff;
      --text-light: #000000;
      --bg-dark: #121212;
      --text-dark: #ffffff;
      --card-bg-light: rgba(0,0,0,0.05);
      --card-bg-dark: rgba(255,255,255,0.1);
      --accent: #ffcc00;
    }
    body {
      margin:0; padding:0;
      font-family:'Tajawal',sans-serif;
      transition:background .3s,color .3s;
    }
    body.light-theme {
      background: var(--bg-light);
      color: var(--text-light);
    }
    body.dark-theme {
      background: var(--bg-dark);
      color: var(--text-dark);
    }
    .topbar {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 20px; background:rgba(0,0,0,0.1);
    }
    body.dark-theme .topbar { background: rgba(255,255,255,0.1); }
    .topbar h1 { margin:0; font-size:1.5em; }
    .buttons { display:flex; align-items:center; }
    .toggle-btn, .auth-btn, .lead-btn {
      margin-left:10px; padding:8px 12px; border:none;
      border-radius:6px; cursor:pointer; transition:background .3s;
    }
    body.light-theme .toggle-btn { background:#333; color:#fff; }
    body.dark-theme .toggle-btn  { background:#eee; color:#000; }
    .auth-btn, .lead-btn { background:#007bff; color:#fff; }
    .auth-btn:hover, .lead-btn:hover { background:#0056b3; }
    #userAvatar { width:32px; height:32px; border-radius:50%; margin-left:10px; display:none; }
    #pointsDisplay {
      display:flex; align-items:center; font-weight:bold;
      margin-left:5px; color: var(--accent); display:none;
    }
    #pointsDisplay img { width:20px; height:20px; margin-left:4px; }

    .glass {
      background: var(--card-bg-light);
      border-radius:12px; padding:20px; margin:20px auto;
      max-width:900px; transition:background .3s;
    }
    body.dark-theme .glass { background: var(--card-bg-dark); }

    .controls { text-align:center; margin-bottom:15px; }
    select, input[type="text"], .btn {
      padding:8px 12px; border-radius:6px; margin:5px;
      border:1px solid #aaa; font-size:1em;
    }
    body.dark-theme select, body.dark-theme input[type="text"] {
      background:#222; color:#ddd; border-color:#555;
    }
    body.light-theme select, body.light-theme input[type="text"] {
      background:#fff; color:#000;
    }
    .btn.search, #loadMore, .btn.share {
      background:#007bff; color:#fff; border:none; cursor:pointer;
      transition:background .3s;
    }
    .btn.search:hover, #loadMore:hover, .btn.share:hover { background:#0056b3; }

    #searchLabel { display:block; margin-bottom:8px; font-weight:bold; }
    #results { display:flex; flex-wrap:wrap; justify-content:center; }
    .script-card {
      width:240px; margin:10px; border-radius:8px; overflow:hidden;
      background: var(--card-bg-light); transition:transform .2s;
    }
    body.dark-theme .script-card { background: var(--card-bg-dark); }
    .script-card:hover { transform:scale(1.03); }
    .script-card img {
      width:100%; height:140px; object-fit:cover;
    }
    .overlay-left, .overlay-right {
      position:absolute; top:8px; padding:4px 8px;
      background:rgba(0,0,0,0.5); color:#fff; border-radius:4px;
      font-size:.8em;
    }
    .overlay-left { left:8px; }
    .overlay-right { right:8px; }

    .script-info { padding:10px; text-align:center; position:relative; }
    .script-info h3 { margin:5px 0; font-size:1em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .script-info .btn-group { display:flex; justify-content:space-between; }

    #loadMore { display:block; margin:20px auto; }

    /* Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙƒØ±Ø¨Øª */
    .modal {
      position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%) scale(0);
      width:90%; max-width:700px;
      background: var(--bg-light); color: var(--text-light);
      padding:20px; border-radius:8px;
      transition:transform .3s; z-index:1000;
    }
    body.dark-theme .modal {
      background: var(--bg-dark); color: var(--text-dark);
    }
    .modal.show { transform:translate(-50%,-50%) scale(1); }
    .modal .close {
      position:absolute; top:8px; right:12px; cursor:pointer; font-size:1.2em;
    }
    .modal .copy-btn {
      position:absolute; bottom:12px; right:12px;
      padding:6px 12px; background:#28a745; color:#fff;
      border:none; border-radius:4px; cursor:pointer;
    }
    .modal .copy-btn:hover { background:#1e7e34; }
    .modal h2 { margin-top:0; text-align:center; }
    .modal pre {
      max-height:60vh; overflow-y:auto;
      background:rgba(0,0,0,0.05); padding:10px; border-radius:4px;
    }

    /* ØµÙØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† */
    #leaderboardPage {
      display:none; padding:20px; max-width:600px; margin:20px auto;
    }
    #leaderboardPage h2 { text-align:center; margin-bottom:10px; }
    #leaderboardList { width:100%; border-collapse: collapse; }
    #leaderboardList th, #leaderboardList td {
      border:1px solid #aaa; padding:8px; text-align:center;
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="light-theme">

  <div class="topbar">
    <h1>Ø§ÙƒØ³Ø¨Ù„ÙˆÙŠØª Ø§Ù„Ø¹Ø±Ø¨</h1>
    <div class="buttons">
      <img id="userAvatar" src="" alt="avatar">
      <div id="pointsDisplay"><img src="https://via.placeholder.com/20?text=â˜…" alt="Ù†Ù‚Ø§Ø·"> <span id="pointsCount">0</span></div>
      <button id="authBtn" class="auth-btn">ØªØ³Ø¬ÙŠÙ„/Ø¯Ø®ÙˆÙ„</button>
      <button id="leadBtn" class="lead-btn">Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†</button>
      <button id="themeToggle" class="toggle-btn">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>
    </div>
  </div>

  <!-- Ù…ØªØµØ¯Ø±ÙˆÙ† -->
  <div id="leaderboardPage">
    <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h2>
    <table id="leaderboardList">
      <thead><tr><th>Ø§Ù„Ù…Ø±ÙƒØ²</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>
      <tbody></tbody>
    </table>
    <button class="btn" onclick="hideLeaderboard()">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <div class="glass" id="mainContent">
    <label id="searchLabel">Ø¨Ø­Ø« Ø¹Ù†: â€”</label>
    <div class="controls">
      <input id="searchInput" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙƒØ±Ø¨Øªâ€¦">
      <button id="searchBtn" class="btn search">Ø¨Ø­Ø«</button><br>
      <select id="modeSelect">
        <option value="fetch">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</option>
        <option value="free">Ù…Ø¬Ø§Ù†ÙŠØ©</option>
        <option value="unverified">ØºÙŠØ± Ù…Ø­Ù‚Ù‚Ø©</option>
        <option value="mostviewed">Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ù‡Ø¯Ø©</option>
        <option value="verified">Ù…Ø­Ù‚Ù‚Ø©</option>
      </select>
    </div>
    <div id="results"></div>
    <button id="loadMore" class="btn" style="display:none;">Ø§Ù„Ù…Ø²ÙŠØ¯</button>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙƒØ±Ø¨Øª -->
  <div id="scriptModal" class="modal">
    <span class="close" onclick="closeModal()">âœ–</span>
    <h2 id="scriptTitle"></h2>
    <pre id="scriptContent"></pre>
    <button class="copy-btn" id="copyBtn">Ù†Ø³Ø®</button>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ / ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="authModal" style="display:none;">
    <div id="authBox" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:8px;z-index:2000;">
      <span id="authClose" style="position:absolute;top:8px;right:8px;cursor:pointer;">âœ–</span>
      <h3 id="authTitle">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
      <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"><br>
      <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><br>
      <input id="confirmPassword" type="password" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="display:none;"><br>
      <button id="authAction" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      <p id="toggleAuth" style="text-align:center;cursor:pointer;color:#007bff;">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</p>
    </div>
  </div>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyCSVCz9s7yHQtpOet9txgHl-E4XBgFmMp0",
      authDomain: "qplkow.firebaseapp.com",
      databaseURL: "https://qplkow-default-rtdb.firebaseio.com",
      projectId: "qplkow",
      storageBucket: "qplkow.appspot.com",
      messagingSenderId: "280525591715",
      appId: "1:280525591715:web:d2f750ebf5ceffe6641b16",
      measurementId: "G-ZC8K2PDE60"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM elements
    const authBtn = document.getElementById('authBtn');
    const authModal = document.getElementById('authModal');
    const authClose = document.getElementById('authClose');
    const authTitle = document.getElementById('authTitle');
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirmPassword');
    const authAction = document.getElementById('authAction');
    const toggleAuth = document.getElementById('toggleAuth');
    const userAvatar = document.getElementById('userAvatar');
    const pointsDisplay = document.getElementById('pointsDisplay');
    const pointsCount = document.getElementById('pointsCount');
    const leadBtn = document.getElementById('leadBtn');
    const leaderboardPage = document.getElementById('leaderboardPage');
    const mainContent = document.getElementById('mainContent');
    const leaderboardList = document.querySelector('#leaderboardList tbody');

    let isRegister = true;
    function updateAuthUI() {
      if (isRegister) {
        authTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
        confirmInput.style.display = 'block';
        authAction.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
        toggleAuth.textContent = 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„';
      } else {
        authTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„';
        confirmInput.style.display = 'none';
        authAction.textContent = 'Ø¯Ø®ÙˆÙ„';
        toggleAuth.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      }
    }
    authBtn.onclick = () => authModal.style.display = 'block';
    authClose.onclick = () => authModal.style.display = 'none';
    toggleAuth.onclick = () => { isRegister = !isRegister; updateAuthUI(); };
    updateAuthUI();

    authAction.onclick = () => {
      const email = emailInput.value.trim();
      const pass  = passInput.value;
      if (!email || !pass) return alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„');
      if (isRegister) {
        if (pass !== confirmInput.value) return alert('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†');
        auth.createUserWithEmailAndPassword(email, pass)
          .then(res => res.user.sendEmailVerification().then(() => alert('ØªØ­Ù‚Ù‚ Ø£Ø±Ø³Ù„')));
      } else {
        auth.signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
      }
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        db.ref('users/' + user.uid).once('value', snap => {
          if (!snap.exists()) db.ref('users/' + user.uid).set({ email: user.email, points: 0 });
        });
        db.ref('users/' + user.uid + '/points').on('value', snap => {
          pointsCount.textContent = snap.val() || 0;
          pointsDisplay.style.display = 'flex';
        });
        userAvatar.src = user.photoURL || 'https://via.placeholder.com/32';
        userAvatar.style.display = 'block';
        authBtn.style.display = 'none';
      } else {
        userAvatar.style.display = 'none';
        pointsDisplay.style.display = 'none';
        authBtn.style.display = 'inline-block';
      }
    });

    // Leaderboard
    leadBtn.onclick = () => {
      if (!auth.currentUser) return alert('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
      mainContent.style.display = 'none';
      leaderboardPage.style.display = 'block';
      // fetch top 10
      db.ref('users').orderByChild('points').limitToLast(10).once('value', snap => {
        const data = [];
        snap.forEach(ch => data.push({ email: ch.val().email, points: ch.val().points }));
        data.reverse();
        leaderboardList.innerHTML = '';
        data.forEach((u,i) => {
          leaderboardList.innerHTML += `<tr><td>${i+1}</td><td>${u.email}</td><td>${u.points}</td></tr>`;
        });
      });
    };
    function hideLeaderboard() {
      leaderboardPage.style.display = 'none';
      mainContent.style.display = 'block';
    }

    // Sharing and points
    function recordShare() {
      const uid = auth.currentUser.uid;
      const ref = db.ref('users/' + uid + '/points');
      ref.transaction(p => (p||0) + 1);
      alert('âœ… Ø´Ø§Ø±ÙƒØª ÙˆØ­ØµÙ„Øª Ù†Ù‚Ø·Ø©!');
    }

    // Site search/ display code as before
    let mode='fetch', query='', page=1, total=1;
    const results = document.getElementById('results');
    const loadMore = document.getElementById('loadMore');
    const searchInput = document.getElementById('searchInput');
    const searchBtnEl = document.getElementById('searchBtn');
    const modeSelect = document.getElementById('modeSelect');
    const searchLabel = document.getElementById('searchLabel');
    const themeToggle = document.getElementById('themeToggle');
    const bodyEl = document.body;
    const scriptModal = document.getElementById('scriptModal');
    const tEl = document.getElementById('scriptTitle');
    const cEl = document.getElementById('scriptContent');
    const copyBtn = document.getElementById('copyBtn');

    function proxy(url) {
      return 'https://api.allorigins.win/raw?url='+encodeURIComponent(url);
    }
    function apiURL() {
      const base='https://scriptblox.com/api/script/';
      const p=`&page=${page}`;
      if(mode==='search') return proxy(base+`search?q=${encodeURIComponent(query)}${p}`);
      return proxy(base+
        (mode==='fetch'?`fetch?page=${page}`:
        mode==='free'?`fetch?mode=free${p}`:
        mode==='unverified'?`fetch?verified=0${p}`:
        mode==='mostviewed'?`fetch?sortBy=views&order=desc${p}`:
        `fetch?filters=verified&legacy_filters=true${p}`));
    }

    async function loadScripts() {
      try {
        if(page===1) results.innerHTML=`<p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>`;
        const res=await fetch(apiURL());
        const data=await res.json();
        const R=data.result||data; total=R.totalPages||1;
        if(page===1) results.innerHTML='';
        if(!R.scripts||!R.scripts.length) {
          if(page===1) results.innerHTML=`<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</p>`;
        } else {
          R.scripts.forEach(s=>{
            const card=document.createElement('div');
            card.className='script-card';
            const date=new Date(s.createdAt).toLocaleDateString('ar-EG');
            const views=s.views||0;
            card.innerHTML=`
              <div style="position:relative;">
                <img src="${s.game?.imageUrl||s.image||'https://via.placeholder.com/240x140'}" alt="">
                <div class="overlay-left">ğŸ‘ï¸ ${views}</div>
                <div class="overlay-right">ğŸ“… ${date}</div>
              </div>
              <div class="script-info">
                <h3>${s.title}</h3>
                <div class="btn-group">
                  <button class="btn share" onclick="shareScript('${s.title}')">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                  <button class="btn" onclick="showScript('${s.slug}','${s.title}')">Ø¹Ø±Ø¶</button>
                </div>
              </div>`;
            results.appendChild(card);
          });
        }
        loadMore.style.display= page<total?'block':'none';
      } catch {
        results.innerHTML=`<p>âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹</p>`;
      }
    }

    async function shareScript(title) {
      if(!auth.currentUser) return alert('Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
      try {
        await navigator.share({ title, url: window.location.href });
        recordShare();
      } catch (err) {
        alert('ÙØ´Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
      }
    }

    async function showScript(slug,title) {
      try {
        const res=await fetch(proxy(`https://scriptblox.com/api/script/${slug}`));
        const d=await res.json(), sc=d.script;
        if(sc&&sc.script) {
          tEl.textContent=title; cEl.textContent=sc.script;
          scriptModal.classList.add('show');
        } else alert('âš ï¸ ØºÙŠØ± Ù…ØªØ§Ø­');
      } catch {
        alert('âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
      }
    }
    function closeModal(){ scriptModal.classList.remove('show'); }

    function doSearch() {
      const q=searchInput.value.trim();
      if(!q) return alert('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø«');
      query=q; mode='search'; page=1; results.innerHTML='';
      searchLabel.textContent=`Ø¨Ø­Ø« Ø¹Ù†: ${q}`; loadScripts();
    }
    searchBtnEl.addEventListener('click', doSearch);
    searchInput.addEventListener('keypress', e=>{ if(e.key==='Enter') doSearch(); });
    modeSelect.addEventListener('change', ()=>{
      mode=modeSelect.value; query=''; page=1; results.innerHTML='';
      searchLabel.textContent='Ø¨Ø­Ø« Ø¹Ù†: â€”'; loadScripts();
    });
    loadMore.addEventListener('click', ()=>{ if(page<total){ page++; loadScripts(); }});
    themeToggle.addEventListener('click', ()=>{
      if(bodyEl.classList.contains('light-theme')) {
        bodyEl.classList.replace('light-theme','dark-theme');
        themeToggle.textContent='Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­';
      } else {
        bodyEl.classList.replace('dark-theme','light-theme');
        themeToggle.textContent='Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ';
      }
    });
    window.addEventListener('load', loadScripts);
  </script>
</body>
</html>
