<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>محرر وحفظ مباشر لـ Lord.lua</title>
  <style>
    body{font-family:system-ui,Arial;direction:rtl;background:#f5f7fb;margin:0;padding:20px}
    .card{max-width:900px;margin:0 auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(20,20,40,0.06)}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:8px;align-items:center}
    input[type=password]{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0b76ef;color:#fff;cursor:pointer}
    button.ghost{background:#6b7280}
    textarea{width:100%;height:380px;margin-top:10px;padding:10px;font-family:monospace;font-size:13px;border-radius:8px;border:1px solid #ddd;resize:vertical}
    .note{color:#666;font-size:13px;margin-top:8px}
    pre#log{height:110px;overflow:auto;background:#f3f6fb;padding:8px;border-radius:8px;border:1px solid #eef2f7}
    label{font-weight:600;margin-top:10px;display:block}
    .small{font-size:13px;color:#444}
  </style>
</head>
<body>
  <div class="card">
    <h1>محرر بسيط — فتح، تعديل، حفظ إلى GitHub</h1>

    <div class="note small">
      الملف الافتراضي: <code>qkdr / Lord / Lord.lua</code> على الفرع <code>main</code>.
      تقدر تغيّرهم داخل الكود لو تريد. ألصق التوكن وقت الحفظ فقط.
    </div>

    <label>Token لـ GitHub (ألصقه فقط وقت الحفظ)</label>
    <div class="row" style="margin-top:6px">
      <input id="token" type="password" placeholder="ألصق هنا PAT (مثال: ghp_xxx)"/>
      <button id="clearToken" class="ghost">مسح التوكن</button>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="editBtn">تعديل</button>
      <button id="saveBtn">حفظ التعديل</button>
      <button id="reloadBtn" class="ghost">جلب الملف مرة أخرى</button>
    </div>

    <label>محتوى الملف</label>
    <textarea id="editor" disabled placeholder="سيظهر محتوى الملف هنا عند التحميل..."></textarea>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="downloadBtn" class="ghost">تنزيل ملف .lua</button>
      <div class="note small" style="margin-left:auto">بعد الحفظ: افتح مستودعك على GitHub وتأكد من الـ commit.</div>
    </div>

    <label style="margin-top:12px">سجل الأحداث</label>
    <pre id="log">جارٍ التحميل...</pre>

    <p class="note small" style="margin-top:10px">
      ملاحظة: هذه الصفحة تتصل مباشرة بـ GitHub API من متصفحك. تأكد أن التوكن يملك صلاحية مناسبة (public_repo أو repo).
    </p>
  </div>

<script>
/* ======= إعداد (غيّر القيم إذا تريد مستودع مختلف) ======= */
const OWNER = "qkdr";
const REPO  = "Lord";
const PATH  = "Lord.lua";
const BRANCH = "main";
/* ========================================================= */

const editor = document.getElementById('editor');
const logEl = document.getElementById('log');
const tokenEl = document.getElementById('token');
const editBtn = document.getElementById('editBtn');
const saveBtn = document.getElementById('saveBtn');
const downloadBtn = document.getElementById('downloadBtn');
const reloadBtn = document.getElementById('reloadBtn');
const clearTokenBtn = document.getElementById('clearToken');

function writeLog(...args){ const t = new Date().toLocaleTimeString(); logEl.textContent = `[${t}] ` + args.join(' ') + "\n" + logEl.textContent; }
function utf8_to_b64(str){ return btoa(unescape(encodeURIComponent(str||""))); }
function b64_to_utf8(b64){ try{ return decodeURIComponent(escape(atob(b64))); }catch(e){ return atob(b64); } }

const apiUrl = `https://api.github.com/repos/${encodeURIComponent(OWNER)}/${encodeURIComponent(REPO)}/contents/${encodeURIComponent(PATH)}`;

let currentSha = null;
let isEditing = false;

async function loadFile(){
  writeLog('جاري جلب الملف من GitHub...', apiUrl, `?ref=${BRANCH}`);
  editor.disabled = true;
  try{
    const res = await fetch(apiUrl + `?ref=${encodeURIComponent(BRANCH)}`, { headers: { Accept: 'application/vnd.github.v3+json' } });
    if(res.status === 404){
      editor.value = "-- الملف غير موجود (404). يمكنك إنشاءه ثم حفظ التعديل لإضافته إلى المستودع.\n";
      currentSha = null;
      writeLog('الملف غير موجود على المستودع. (سيتم إنشاء ملف جديد عند الحفظ)');
      return;
    }
    if(!res.ok) throw new Error('HTTP '+res.status + ' ' + await res.text());
    const j = await res.json();
    const content = j.content ? b64_to_utf8(j.content.replace(/\n/g,'')) : '';
    editor.value = content;
    currentSha = j.sha || null;
    writeLog('تم جلب الملف بنجاح. sha:', currentSha);
  }catch(err){
    editor.value = `-- خطأ أثناء جلب الملف:\n-- ${err.message}\n`;
    writeLog('خطأ جلب الملف:', err.message);
  } finally {
    editor.scrollTop = 0;
  }
}

editBtn.addEventListener('click', ()=>{
  if(!isEditing){
    isEditing = true;
    editor.disabled = false;
    editor.focus();
    editBtn.textContent = 'إلغاء التعديل';
    writeLog('الوضع: تحرير مفعل');
  } else {
    isEditing = false;
    editor.disabled = true;
    editBtn.textContent = 'تعديل';
    writeLog('الوضع: تحرير معطل');
  }
});

downloadBtn.addEventListener('click', ()=>{
  const blob = new Blob([editor.value], { type: 'text/plain;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = PATH.split('/').pop() || 'file.lua';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(a.href);
  writeLog('تم تنزيل الملف محليًا');
});

clearTokenBtn.addEventListener('click', ()=>{
  tokenEl.value = '';
  writeLog('تم مسح التوكن من الحقل');
});

reloadBtn.addEventListener('click', ()=>{ loadFile(); });

saveBtn.addEventListener('click', async ()=>{
  const token = tokenEl.value.trim();
  if(!token){
    alert('لا يوجد توكن. ألصق توكن GitHub (PAT) في الحقل أولاً لكي يتم الحفظ إلى المستودع.');
    return;
  }
  if(!confirm('هل تريد حفظ التغييرات وإرسالها إلى GitHub كمؤرّخ (commit)؟')) return;

  writeLog('بدء حفظ الملف إلى GitHub...');
  const contentB64 = utf8_to_b64(editor.value);
  const body = {
    message: `Update ${PATH} via web editor`,
    content: contentB64,
    branch: BRANCH
  };
  if(currentSha) body.sha = currentSha;

  try{
    const res = await fetch(apiUrl, {
      method: 'PUT',
      headers: {
        'Authorization': 'token ' + token,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    const txt = await res.text();
    if(res.status === 200 || res.status === 201){
      const j = JSON.parse(txt);
      currentSha = (j.content && j.content.sha) ? j.content.sha : currentSha;
      writeLog('نجح الحفظ! commit sha:', j.commit && j.commit.sha ? j.commit.sha : '(unknown)');
      alert('تم الحفظ بنجاح إلى GitHub!');
      // بعد الحفظ نوقف التحرير تلقائياً
      isEditing = false; editor.disabled = true; editBtn.textContent = 'تعديل';
    } else {
      writeLog('فشل الحفظ:', res.status, txt);
      alert('فشل الحفظ. افتح سجل الأحداث لمعرفة التفاصيل.');
    }
  }catch(err){
    writeLog('خطأ أثناء عملية الحفظ:', err.message);
    alert('حدث خطأ أثناء الحفظ. افتح السجل لمعرفة التفاصيل.');
  }
});

/* تحميل تلقائي عند فتح الصفحة */
loadFile();
</script>
</body>
</html>
